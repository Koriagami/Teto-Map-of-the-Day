// Prisma schema for Teto Bot
// Configured for PostgreSQL (Railway)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ServerConfig {
  id                 String   @id @default(uuid())
  guildId            String   @unique
  tmotdChannelId     String?  // Channel for Teto Map of the Day messages
  challengesChannelId String?  // Channel for challenge messages
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("server_configs")
}

model Submission {
  id             String   @id @default(uuid())
  guildId        String
  userId         String
  submissionDate String   // YYYY-MM-DD format
  createdAt      DateTime @default(now())

  @@unique([guildId, userId, submissionDate])
  @@index([guildId, userId])
  @@map("submissions")
}

model UserAssociation {
  id              String   @id @default(uuid())
  guildId         String
  discordUserId   String
  discordUsername String
  osuUsername     String?
  osuUserId       String?
  profileLink     String
  linkedAt        DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([guildId, discordUserId])
  @@index([guildId, discordUserId])
  @@index([osuUserId])
  @@index([osuUsername])
  @@map("user_associations")
}

model ActiveChallenge {
  id                    String   @id @default(uuid())
  guildId               String
  beatmapId             String
  difficulty            String   // beatmap version/difficulty name
  challengerUserId      String   // Discord user ID who currently holds the challenge
  challengerOsuId       String   // OSU user ID
  challengerScore       Json     // Full score data from OSU API
  originalChallengerUserId String // Discord user ID who originally issued the challenge
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt // Last time the champion changed

  @@unique([guildId, beatmapId, difficulty])
  @@index([guildId])
  @@index([beatmapId])
  @@map("active_challenges")
}
